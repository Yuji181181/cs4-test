{% extends 'base.html' %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-900 flex-shrink-0 flex flex-col border-r border-gray-800">
        <div class="h-16 flex items-center px-4 border-b border-gray-800">
            <h1 class="text-xl font-bold text-white">Slack Clone</h1>
        </div>
        <div class="flex-1 overflow-y-auto py-4">
            <h2 class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Channels</h2>
            <nav class="space-y-1">
                {% for channel in channels %}
                <a href="{% url 'channel_chat' channel.name %}"
                    class="group flex items-center px-4 py-2 text-sm font-medium {% if channel.name == room_name %}bg-gray-800 text-white{% else %}text-gray-400 hover:bg-gray-800 hover:text-white{% endif %}">
                    <span class="mr-2 text-gray-500">#</span>
                    {{ channel.name }}
                </a>
                {% endfor %}
            </nav>
        </div>
        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center">
                <div class="text-sm">
                    <p class="text-white font-medium">{{ user.username }}</p>
                    <form action="{% url 'logout' %}" method="post" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="text-xs text-gray-500 hover:text-gray-300">ログアウト</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-gray-800 min-w-0">
        {% if room_name %}
        <!-- Channel Header -->
        <div class="h-16 flex items-center px-6 border-b border-gray-700 bg-gray-800 shadow-sm">
            <h2 class="text-lg font-bold text-white"># {{ room_name }}</h2>
            {% if current_channel.description %}
            <span class="ml-4 text-sm text-gray-400 border-l border-gray-600 pl-4">{{ current_channel.description
                }}</span>
            {% endif %}
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for message in messages %}
            <div class="flex items-start">
                <div
                    class="flex-shrink-0 h-10 w-10 rounded bg-indigo-500 flex items-center justify-center text-white font-bold select-none">
                    {{ message.user.username|make_list|first|upper }}
                </div>
                <div class="ml-4">
                    <div class="flex items-baseline">
                        <span class="text-sm font-bold text-white mr-2">{{ message.user.username }}</span>
                        <span class="text-xs text-gray-400">{{ message.created_at|date:"H:i" }}</span>
                    </div>
                    <p class="text-gray-300 text-sm mt-1 whitespace-pre-wrap">{{ message.content }}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-gray-800 border-t border-gray-700">
            <div class="bg-gray-700 rounded-lg p-2">
                <textarea id="chat-message-input" rows="1"
                    class="w-full bg-transparent text-white border-0 focus:ring-0 resize-none px-2 py-1"
                    placeholder="# {{ room_name }} へのメッセージ"></textarea>
                <div class="flex justify-end mt-2">
                    <button id="chat-message-submit"
                        class="p-1 rounded text-gray-400 hover:text-white hover:bg-gray-600 transition-colors">
                        <svg class="h-5 w-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="flex-1 flex items-center justify-center text-gray-500">
            <div class="text-center">
                <h3 class="text-xl font-medium text-gray-400">チャンネルを選択してください</h3>
                <p class="mt-2">左のサイドバーからチャンネルを選んでチャットに参加しましょう。</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if room_name %}
{{ room_name|json_script:"room-name" }}
{{ user.username|json_script:"user-name" }}
<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const userName = JSON.parse(document.getElementById('user-name').textContent);

    // Construct WebSocket URL per environment (handling codespaces/devcontainer logic if needed, but assuming standard here)
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const chatSocket = new WebSocket(
        protocol + '//' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    const messagesContainer = document.querySelector('#chat-messages');

    // Scroll to bottom functionality
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    // Initial scroll
    scrollToBottom();

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.username;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Create message element
        const messageElement = document.createElement('div');
        messageElement.className = 'flex items-start';
        messageElement.innerHTML = `
            <div class="flex-shrink-0 h-10 w-10 rounded bg-indigo-500 flex items-center justify-center text-white font-bold select-none">
                ${sender.charAt(0).toUpperCase()}
            </div>
            <div class="ml-4">
                <div class="flex items-baseline">
                    <span class="text-sm font-bold text-white mr-2">${sender}</span>
                    <span class="text-xs text-gray-400">${time}</span>
                </div>
                <p class="text-gray-300 text-sm mt-1 whitespace-pre-wrap">${message}</p>
            </div>
        `;

        messagesContainer.appendChild(messageElement);
        scrollToBottom();
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13 && !e.shiftKey) {  // Enter (without shift)
            e.preventDefault();
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        if (message.trim()) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        }
    };
</script>
{% endif %}
{% endblock %}